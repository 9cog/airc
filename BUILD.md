# Build Guide for RC Shell with AI Integration

This document explains how to build the rc shell and addresses common build issues.

## Quick Build

```bash
make
make install  # requires root
```

## Build Options

### Line Editing Library

RC supports multiple line editing libraries:

```bash
make EDIT=readline     # GNU readline
make EDIT=editline     # BSD libedit
make EDIT=bestline     # Bestline
make EDIT=vrl          # VRL
make EDIT=edit         # Basic edit
make EDIT=null         # No line editing (default)
```

### Custom Installation Prefix

```bash
make PREFIX=/opt/rc install
```

## Build Requirements

- C compiler (GCC or Clang)
- Make
- yacc or bison (for parsing grammar)
- Optional: line editing library (readline, editline, etc.)

## Build Process Details

The build process involves several generated files:

1. **parse.c** and **parse.h** - Generated from parse.y using yacc/bison
2. **parse.tab.h** - Symlink to parse.h (for compatibility)
3. **sigmsgs.c** - Generated by mksignal
4. **statval.h** - Generated by mkstatval
5. **version.h** - Generated from git describe or VERSION
6. **config.h** - Copied from config.def.h

### Parse File Issue (Fixed)

**Issue:** The Makefile renames `parse.tab.h` to `parse.h`, but the generated `parse.c` includes `parse.tab.h`.

**Solution:** The Makefile now automatically creates a symlink from `parse.tab.h` to `parse.h` as part of the build process. This ensures that `parse.c` can find the header file it needs.

This fix was implemented by adding:
- A dependency rule ensuring `parse.tab.h` exists before compiling object files
- An automatic symlink creation rule in the Makefile

## Testing

Run the test suite:

```bash
make check
```

This runs:
- `trip.rc` - comprehensive shell functionality tests
- `test-history` - history file manipulation tests

## Common Build Issues

### Issue: "parse.tab.h: No such file or directory"

**Solution:** This is now fixed automatically. If you still see this error:

```bash
make clean
make
```

The Makefile will create the required symlink.

### Issue: "yacc: command not found"

**Solution:** Install bison:

```bash
# Ubuntu/Debian
sudo apt-get install bison

# macOS
brew install bison

# Fedora/RHEL
sudo dnf install bison
```

### Issue: Line editing library not found

**Solution:** Install the library or use `EDIT=null`:

```bash
# For readline
sudo apt-get install libreadline-dev

# For editline
sudo apt-get install libedit-dev

# Or build without line editing
make EDIT=null
```

## Building for AI Integration

The AI integration features don't require any special build flags. Just build rc normally:

```bash
make
```

Then test the integration:

```bash
./demo-integration.sh
```

Or run the integration test suite:

```bash
./test-integration.sh
```

## Development Build

For development with debugging symbols:

```bash
make CFLAGS="-g -O0 -Wall"
```

## Clean Build

To start fresh:

```bash
make clean      # Remove build artifacts
make distclean  # Remove all generated files including config.h
```

## Cross-Compilation

RC can be cross-compiled by setting CC and related variables:

```bash
make CC=arm-linux-gnueabi-gcc
```

## Troubleshooting

### Build fails with "config.h not found"

**Solution:**

```bash
make config.h
make
```

### Build fails with missing functions

**Solution:** Check config.def.h and adjust for your system, then:

```bash
cp config.def.h config.h
# Edit config.h as needed
make
```

### Tests fail

**Solution:** Some tests may fail on certain systems. This is often normal. Focus on:

```bash
./rc -c 'echo test'  # Basic functionality
./test-integration.sh  # AI integration tests
```

## CI/CD Builds

The project includes GitHub Actions CI that builds and tests on:
- Ubuntu (latest)
- macOS (latest)

See `.github/workflows/ci.yml` for details.

## Further Help

- See `README` for general information
- See `AI_INTEGRATION.md` for AI chat integration details
- See `USAGE_GUIDE.md` for usage examples
- Check the `Makefile` for all available targets

## License

RC is distributed under the terms described in the COPYING file.
